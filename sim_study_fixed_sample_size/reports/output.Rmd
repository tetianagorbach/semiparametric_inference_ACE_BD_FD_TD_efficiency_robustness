---
title: "Simulation study 2 with fixed sample size"
author: "Tetiana Gorbach"
date: "2/23/2021"
output:
  pdf_document: default
  toc: yes
  toc_depth: 2
  html_document: default
---

```{r setup, include=FALSE}
library(tidyverse)
```
\tableofcontents

```{r, read results, echo=F}
load("../results/results_sim_fixed_sample_size2021-02-24.Rdata")
sim.results <- as.data.frame(sim.results)

```

```{r, transfrom sim.results, echo=F}
# First, I transform sim.results into a long format and calculate scaled empirical variance:
sim.results.long <-  sim.results%>%select(dgp,  beta1, gamma1, gamma2, n, 
                    FD = est.fd.semipar,`TD FD` = est.eif.td.fd.semipar,
                    BD = est.bd.semipar,  `TD BD` = est.eif.td.bd.semipar,
                    TD = est.td.semipar,   `TD BD FD` = est.eif.all.semipar)%>%
        gather(Method, ate.est, FD:`TD BD FD`, factor_key=TRUE)%>%
        group_by(dgp, Method)%>%
        summarise(beta1 = mean(beta1), 
                  gamma1 = mean(gamma1), 
                  gamma2 = mean(gamma2),
                sc.emp.var = var(sqrt(n) * ate.est))%>%
        ungroup()
```

```{r, helper plot, echo=F}
cbbPalette <- c("#E69F00","#D55E00", "#56B4E9", "#0072B2", "#009E73", "#000000") # colorblind-friendly pallette
names(cbbPalette) <- levels(sim.results.long$Method)

plot_wrap <- function(dat){
        
        ggplot(dat, aes(x = gamma2, y = sc.emp.var))+ 
        geom_line(aes(group = Method, col= Method)) + 
        facet_wrap(beta1~gamma1,  scales= "free", labeller = label_both) +
        theme_bw() +
        scale_colour_manual(values=cbbPalette)
}

plot_grid <- function(dat){
        ggplot(dat, aes(x = gamma2, y = sc.emp.var))+ 
        geom_line(aes(group = Method, col= Method)) + 
        facet_grid(beta1~gamma1,  scales= "free", labeller = label_both) +
        theme_bw() +
        scale_colour_manual(values=cbbPalette)
}
```

The data generating process is adapted from the simulation study in Fulcher et al, 2020 to the DAG in Figure 1a:

$$ C \sim \text{Bern}(0.5) $$
$$ A|C \sim \text{Bern}\{expit (0.5C)\}$$
$$ Z|A \sim N(\beta_1A,1)$$
$$ Y|Z, C \sim N(1+\gamma_1Z+\gamma_2C,1).$$

Parameter values in the simulations are

* sample size = `r sample.size`

* number sample of replicates K = `r number.of.replicates`

* $\beta_1$ = `r unique(sim.results$beta1)`

* $\gamma_1$ = `r unique(sim.results$gamma1)`

* $\gamma_2$ = `r unique(sim.results$gamma2)`

* $\sigma_z = 1$

* $\sigma_y = 1$


Expectations from the simulations study:

* Since considered data model satisfies all the criteria,  the EIF constructed under the assumption that all the criteria are fulfilled (called later "TD BD FD") should have the lowest empirical variance

* The variance of the influence function constructed under TD and BD assumptions  simultaneously (called "TD BD") should be smaller than the variance of the IFs under only TD  or only BD assumptions

* The variance of the influence function constructed under TD and FD assumptions simultaneously (called "TD FD") should be smaller than the variance of the IFs under only TD or only FD assumptions

* The variance of the influence function constructed under FD and BD assumptions simultanesouly (equal to "TD BD FD") should be smaller than the variance of the IFs under only FD or under only BD assumptions


\newpage 
# Scaled empirical variance, all methods together 

Plot all the results. Not possible to see anything, except that the results for positive and negative values of the parameters seem to be approximatelly symmetrical. 
That is why I  will later construct plots only for positive values of the parameters. 

```{r, plot, fig.height=10, fig.width=10, echo=F}
sim.results.long%>%
        plot_grid
```

\newpage
Plot for only positive values of the parameters. 
Conclusions from the plot:

* Still hard to distinquish between the lines for low $\beta_1$

* Empirical variances increase with increasing $\gamma_1$ (effect of Z on Y).

* The emp. variance of the BD estimator is higher than the others unless $\beta_1$ is big (last row). For big $\beta_1$ FD, TD, and TD+FD have higher variances.

```{r, plot pos, fig.height=10, fig.width=10, echo=F}
sim.results.long%>% 
        filter(beta1>0, gamma2>0, gamma1>0)%>%
        plot_wrap
```

\newpage
```{r, plot without extremes in fd, eval=F, fig.height=10, fig.width=10, echo=F, fig.show='hide'}
sim.results%>%
        filter(est.var.fd.semipar < 50)%>%
        select(dgp,  beta1, gamma1, gamma2, n, 
               FD =est.fd.semipar, BD = est.bd.semipar,   TD = est.td.semipar,  
               `TD BD` = est.eif.td.bd.semipar, `TD FD` = est.eif.td.fd.semipar, `TD BD FD` = est.eif.all.semipar)%>%
        gather(Method, ate.est, FD:`TD BD FD`, factor_key=TRUE)%>%
        group_by(dgp, Method)%>%
        summarise(beta1 = mean(beta1), 
                  gamma1 = mean(gamma1), 
                  gamma2 = mean(gamma2),
                sc.emp.var = var(sqrt(n) * ate.est))%>%
        ungroup()%>%
        filter(beta1>0, gamma2>0, gamma1>0)%>%
        plot_gg
```

\newpage
# Scaled empirical variance for TD,  BD and TD+BD

* BD variance is higher than TD for small $\beta_1$ (this is expected from the Examples in the paper). 

* As expected, the empirical variance of TD+BD seems to be smaller than individual variance of TD or BD for any combination of parameters (maybe hard to evaluate for small $\beta_1$, see the plot on the next page)

* TD BD FD has the lowest variance (see the plot on the next page). 

```{r, plot TD BD, fig.height=10, fig.width=10, echo=F}
sim.results.long%>% 
        filter(beta1>0, gamma2>0, gamma1>0, Method %in% c("TD", "BD", "TD BD", "TD BD FD"))%>%
        plot_wrap
```

\newpage
## Scaled empirical variance for TD,  BD and TD+BD (without BD)

To be able to compare TD, TD+BD, TD+BD+FD  for small $\beta_1$, I do not plot BD:

```{r, plot TD BD beta, fig.height=10, fig.width=10, echo=F}
sim.results.long%>% 
        filter(beta1>0, gamma2>0, gamma1>0, Method %in% c("TD", "TD BD", "TD BD FD"))%>%
        plot_wrap
```

\newpage
# Scaled empirical variance for TD,  FD and TD+FD

* As expected, the empirical variance of TD+FD seems to be smaller than individual variance of TD or FD for any combination of parameters. 

* TD BD FD has the lowest variance (I blame the result for $\beta_1 = 0.1$ and $gamma_1=2$ on sampling variablility, see next page). 

```{r, plot TD FD, fig.height=10, fig.width=10, echo=F}
sim.results.long%>% 
        filter(beta1>0, gamma2>0, gamma1>0, Method %in% c("TD", "FD", "TD FD", "TD BD FD"))%>%
        plot_wrap
```





\newpage
# Scaled empirical variance for FD,  BD and BD+FD (=TD BD FD)

* TD BD FD has the lowest variance. 

```{r, plot BD FD, fig.height=10, fig.width=10, echo=F}
sim.results.long%>% 
        filter(beta1>0, gamma2>0, gamma1>0, Method %in% c("BD", "FD", "TD BD FD"))%>%
        plot_wrap
```


\newpage
## Scaled empirical variance for FD,  BD and BD+FD (=TD BD FD) (without Bd)


* As expected, the empirical variance of TD BD FD seems to be smaller than individual variance of FD or BD for any combination of parameters.

```{r, plot BD FD wo BD, fig.height=10, fig.width=10, echo=F}
sim.results.long%>% 
        filter(beta1>0, gamma2>0, gamma1>0, Method %in% c("FD", "TD BD FD"))%>%
        plot_wrap
```



\newpage
# Summary

 * The empirical results from the simulation study correspond to the expectations.
 
 * Show bounds?
